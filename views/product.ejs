<%- include('layout', { title: product.title, user: user, cartCount: cartCount, wishlist: (session && session.wishlist) || [] , body: '' }) %>

<section class="product-page">
  <a href="/" class="back-link">← Back to shop</a>

  <div class="product-wrapper">
    <div class="gallery">
      <div class="main-image-wrap">
        <img id="mainImage" class="main-image" src="<%= product.images[Object.keys(product.images)[0]][0] %>" alt="<%= product.title %>">
      </div>

      <div id="thumbs" class="thumbnail-row">
        <% let firstColor = Object.keys(product.images)[0]; %>
        <% product.images[firstColor].forEach((img, i) => { %>
          <img class="thumbnail <%= i===0 ? 'active':'' %>" src="<%= img %>" data-img="<%= img %>">
        <% }) %>
      </div>
    </div>

    <div class="details">
      <h1><%= product.title %></h1>
      <div class="rating-line">
        <div class="avg-rating"><%= avgRating ? avgRating.toFixed(1) : "0.0" %></div>
        <div class="stars"><%= '★'.repeat(Math.round(avgRating||0)) %><%= '☆'.repeat(5 - Math.round(avgRating||0)) %></div>
        <div class="review-count">(<%= (product.reviews||[]).length %> reviews)</div>
      </div>

      <p class="price">₹<%= product.price %></p>
      <p class="desc"><%= product.desc %></p>

      <label><strong>Choose Colour:</strong></label>
      <select id="colorSelect" class="color-select">
        <% Object.keys(product.images).forEach((c, idx) => { %>
          <option value="<%= c %>" <%= idx===0 ? 'selected':'' %>><%= c %> (<%= product.stock[c] || 0 %>)</option>
        <% }) %>
      </select>

      <form method="post" action="/cart/add" class="add-cart">
        <input type="hidden" name="id" value="<%= product.id %>">
        <input type="hidden" id="selectedColorInput" name="color" value="<%= Object.keys(product.images)[0] %>">
        <input type="hidden" name="qty" value="1" />
        <button class="btn primary">Add to cart</button>
      </form>

      <form method="post" action="/wishlist/toggle" style="margin-top:8px;">
        <input type="hidden" name="productId" value="<%= product.id %>" />
        <button class="btn secondary"><%= (typeof wishlist !== 'undefined' && wishlist || []).includes(product.id) ? 'Remove from Wishlist ♥' : 'Add to Wishlist ♡' %></button>
      </form>
    </div>
  </div>

  <!-- Reviews -->
  <div class="reviews-area">
    <div class="reviews-header">
      <h2>Reviews</h2>
      <div class="sort-box">
        <form id="sortForm" method="get" action="/product/<%= product.id %>">
          <label>Sort:</label>
          <select name="sort" onchange="document.getElementById('sortForm').submit()">
            <option value="newest" <%= sort==='newest' ? 'selected':'' %>>Newest</option>
            <option value="highest" <%= sort==='highest' ? 'selected':'' %>>Highest</option>
            <option value="lowest" <%= sort==='lowest' ? 'selected':'' %>>Lowest</option>
          </select>
        </form>
      </div>
    </div>

    <div class="reviews">
      <% if (!reviews || reviews.length===0) { %>
        <p>No reviews yet. Be the first!</p>
      <% } else { %>
        <% reviews.forEach(r => { %>
          <div class="review-card">
            <div class="review-top">
              <strong><%= r.user %></strong>
              <span class="review-date"><%= new Date(r.createdAt).toLocaleDateString() %></span>
            </div>
            <div class="review-stars"><%= '★'.repeat(r.rating) %><%= '☆'.repeat(5-r.rating) %></div>
            <p><%= r.comment %></p>
          </div>
        <% }) %>
      <% } %>
    </div>

    <div class="review-form-wrap">
      <h3>Add your review</h3>
      <form method="post" action="/review/add" class="review-form">
        <input type="hidden" name="productId" value="<%= product.id %>" />
        <label>Rating:</label>
        <select name="rating" required>
          <option value="5">5 — Excellent</option>
          <option value="4">4 — Good</option>
          <option value="3">3 — Okay</option>
          <option value="2">2 — Not great</option>
          <option value="1">1 — Bad</option>
        </select>
        <label>Comment:</label>
        <textarea name="comment" required></textarea>
        <button class="btn">Submit Review</button>
      </form>
    </div>
  </div>

  <!-- safe JSON embed -->
  <div id="productData" data-json='<%- JSON.stringify(product).replace(/'/g, "&#39;") %>' style="display:none"></div>
</section>

<script>
  // read product safely from embedded data attribute
  const PRODUCT = JSON.parse(document.getElementById('productData').dataset.json);

  (function(){
    const main = document.getElementById('mainImage');
    const thumbsRow = document.getElementById('thumbs');
    const colorSelect = document.getElementById('colorSelect');
    const selectedColorInput = document.getElementById('selectedColorInput');

    function bindThumbs() {
      document.querySelectorAll('.thumbnail').forEach(el => {
        el.addEventListener('click', function(){
          document.querySelectorAll('.thumbnail').forEach(x=>x.classList.remove('active'));
          el.classList.add('active');
          main.src = el.dataset.img;
        });
      });
    }

    bindThumbs();

    colorSelect.addEventListener('change', function(){
      const color = this.value;
      selectedColorInput.value = color;
      const imgs = (PRODUCT.images && PRODUCT.images[color]) || [];
      thumbsRow.innerHTML = imgs.map((img, i) => `<img class="thumbnail ${i===0?'active':''}" src="${img}" data-img="${img}">`).join('');
      main.src = imgs[0] || main.src;
      bindThumbs();
    });
  })();
</script>
